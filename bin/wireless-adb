#!/usr/bin/env bash


enable_wireless() {
    echo "Enabling wireless debugging..."

    adb shell settings put global adb_wifi_enabled 1

    IP=$(adb shell ip addr show wlan0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)

    if [ -z "$IP" ]; then
        echo "Error: Could not get device IP address. Is WiFi connected?"
        exit 1
    fi

    echo "Device IP: $IP"

    adb tcpip 5555
    sleep 2

    echo "Connecting to $IP:5555..."
    adb connect $IP:5555

    echo "Connected. You can disconnect USB."
}

disable_wireless() {
    echo "Disabling wireless debugging..."

    DEVICES=$(adb devices | grep $'\tdevice$' | awk '{print $1}')

    if [ -z "$DEVICES" ]; then
        echo "No devices connected"
        exit 1
    fi

    for DEVICE in $DEVICES; do
        echo "Attempting to disable wireless debugging on $DEVICE..."

        adb -s "$DEVICE" shell settings put global adb_wifi_enabled 0 2>/dev/null && {
            echo "✓ Disabled wireless debugging on $DEVICE"
        } || {
            echo "✗ Failed to disable on $DEVICE"
        }
    done

    echo "Wireless debugging disabled"
}

show_status() {
    adb devices -l
    WIRELESS=$(adb devices | grep -E ':[0-9]+\s+device' | wc -l)
    [ "$WIRELESS" -gt 0 ] && echo "Wireless connections: $WIRELESS" || echo "No wireless connections"
}

case "$1" in
    enable)
        enable_wireless
        ;;
    disable)
        disable_wireless
        ;;
    status)
        show_status
        ;;
    *)
        echo "Usage: wireless-adb [enable|disable|status]"
        exit 1
        ;;
esac
