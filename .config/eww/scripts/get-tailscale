#!/bin/bash
# Get current exit node info from tailscale

exit_node=$(tailscale status --json 2>/dev/null | jq -r '.Peer | to_entries[] | select(.value.ExitNode == true) | .value.HostName // empty' 2>/dev/null)

if [[ -z "$exit_node" ]]; then
    echo '{"text": "", "tooltip": "No exit node", "connected": false}'
    exit 0
fi

country=$(tailscale exit-node list 2>/dev/null | grep -F "$exit_node" | awk '{print $3}')

declare -A flags=(
    ["Albania"]="ðŸ‡¦ðŸ‡±" ["Argentina"]="ðŸ‡¦ðŸ‡·" ["Australia"]="ðŸ‡¦ðŸ‡º" ["Austria"]="ðŸ‡¦ðŸ‡¹"
    ["Belgium"]="ðŸ‡§ðŸ‡ª" ["Brazil"]="ðŸ‡§ðŸ‡·" ["Bulgaria"]="ðŸ‡§ðŸ‡¬" ["Canada"]="ðŸ‡¨ðŸ‡¦"
    ["Chile"]="ðŸ‡¨ðŸ‡±" ["Colombia"]="ðŸ‡¨ðŸ‡´" ["Croatia"]="ðŸ‡­ðŸ‡·" ["Czech"]="ðŸ‡¨ðŸ‡¿"
    ["Denmark"]="ðŸ‡©ðŸ‡°" ["Estonia"]="ðŸ‡ªðŸ‡ª" ["Finland"]="ðŸ‡«ðŸ‡®" ["France"]="ðŸ‡«ðŸ‡·"
    ["Germany"]="ðŸ‡©ðŸ‡ª" ["Greece"]="ðŸ‡¬ðŸ‡·" ["Hong"]="ðŸ‡­ðŸ‡°" ["Hungary"]="ðŸ‡­ðŸ‡º"
    ["Iceland"]="ðŸ‡®ðŸ‡¸" ["India"]="ðŸ‡®ðŸ‡³" ["Indonesia"]="ðŸ‡®ðŸ‡©" ["Ireland"]="ðŸ‡®ðŸ‡ª"
    ["Israel"]="ðŸ‡®ðŸ‡±" ["Italy"]="ðŸ‡®ðŸ‡¹" ["Japan"]="ðŸ‡¯ðŸ‡µ" ["Latvia"]="ðŸ‡±ðŸ‡»"
    ["Luxembourg"]="ðŸ‡±ðŸ‡º" ["Malaysia"]="ðŸ‡²ðŸ‡¾" ["Mexico"]="ðŸ‡²ðŸ‡½" ["Moldova"]="ðŸ‡²ðŸ‡©"
    ["Netherlands"]="ðŸ‡³ðŸ‡±" ["New"]="ðŸ‡³ðŸ‡¿" ["Nigeria"]="ðŸ‡³ðŸ‡¬" ["North"]="ðŸ‡²ðŸ‡°"
    ["Norway"]="ðŸ‡³ðŸ‡´" ["Philippines"]="ðŸ‡µðŸ‡­" ["Poland"]="ðŸ‡µðŸ‡±" ["Portugal"]="ðŸ‡µðŸ‡¹"
    ["Romania"]="ðŸ‡·ðŸ‡´" ["Serbia"]="ðŸ‡·ðŸ‡¸" ["Singapore"]="ðŸ‡¸ðŸ‡¬" ["Slovakia"]="ðŸ‡¸ðŸ‡°"
    ["Slovenia"]="ðŸ‡¸ðŸ‡®" ["South"]="ðŸ‡¿ðŸ‡¦" ["Spain"]="ðŸ‡ªðŸ‡¸" ["Sweden"]="ðŸ‡¸ðŸ‡ª"
    ["Switzerland"]="ðŸ‡¨ðŸ‡­" ["Taiwan"]="ðŸ‡¹ðŸ‡¼" ["Thailand"]="ðŸ‡¹ðŸ‡­" ["Turkey"]="ðŸ‡¹ðŸ‡·"
    ["UAE"]="ðŸ‡¦ðŸ‡ª" ["UK"]="ðŸ‡¬ðŸ‡§" ["Ukraine"]="ðŸ‡ºðŸ‡¦" ["USA"]="ðŸ‡ºðŸ‡¸"
)

flag="${flags[$country]:-ðŸŒ}"
city=$(tailscale exit-node list 2>/dev/null | grep -F "$exit_node" | awk '{print $4}')

echo "{\"text\": \"$flag\", \"tooltip\": \"$country ($city)\", \"connected\": true}"
