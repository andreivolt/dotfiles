#!/bin/bash
# Check for battery in order of preference
for p in /sys/class/power_supply/macsmc-battery /sys/class/power_supply/BAT0 /sys/class/power_supply/BAT1; do
    [[ -d "$p" ]] && bat_path="$p" && break
done
[[ -z "$bat_path" ]] && echo '{"percent":100,"charging":false,"text":"󰁹 100%","tooltip":"No battery"}' && exit

capacity=$(cat "$bat_path/capacity" 2>/dev/null || echo 100)
status=$(cat "$bat_path/status" 2>/dev/null || echo "Unknown")
charging=$([[ "$status" == "Charging" ]] && echo true || echo false)

if [[ "$charging" == "true" ]]; then
    icon="󰂄"
    tooltip="Charging: ${capacity}%"
elif ((capacity >= 90)); then icon="󰁹"
elif ((capacity >= 80)); then icon="󰂂"
elif ((capacity >= 70)); then icon="󰂁"
elif ((capacity >= 60)); then icon="󰂀"
elif ((capacity >= 50)); then icon="󰁿"
elif ((capacity >= 40)); then icon="󰁾"
elif ((capacity >= 30)); then icon="󰁽"
elif ((capacity >= 20)); then icon="󰁼"
elif ((capacity >= 10)); then icon="󰁻"
else icon="󰁺"
fi

if [[ "$charging" != "true" ]]; then
    time_to_empty=$(cat "$bat_path/time_to_empty_now" 2>/dev/null)
    if [[ -n "$time_to_empty" && "$time_to_empty" != "0" ]]; then
        # time_to_empty_now is in seconds
        hours=$((time_to_empty / 3600))
        mins=$(((time_to_empty % 3600) / 60))
        tooltip="${hours}h ${mins}m remaining"
    else
        tooltip="${capacity}% remaining"
    fi
fi

echo "{\"percent\":$capacity,\"charging\":$charging,\"text\":\"$icon $capacity%\",\"tooltip\":\"$tooltip\"}"
