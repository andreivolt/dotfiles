#!/usr/bin/env bash

set -euo pipefail

export SOPS_AGE_KEY_FILE=~/.config/sops/age/keys.txt
export GIT_WORK_TREE=~ GIT_DIR=~/.local/share/dotfiles.git

echo "Decrypting all encrypted dotfiles..."

git ls-files -z | grep -z "\.enc\.yaml$" | while IFS= read -r -d '' encrypted_file; do
    file="${encrypted_file%.enc.yaml}"

    echo "Decrypting $file..."

    sops --decrypt --output-type=binary "$encrypted_file" > "$file"

    echo "âœ“ Decrypted to $file"
done

echo "All encrypted files decrypted successfully!"
