#!/usr/bin/env nix-shell
#!nix-shell -i ruby -p ruby readability-cli

require 'open3'

# Get list of tabs from brotab
tab_list, _ = Open3.capture2('bt list')

# Parse the tab information
tabs = []
tab_list.each_line do |line|
  parts = line.strip.split(' ')
  next if parts.empty?
  
  id = parts[0]
  url = parts[-1]
  title = parts[1..-2].join(' ')
  title.gsub!(/"/, '\\"')
  
  tabs << [id, title, url]
end

# Generate data for fzf
fzf_input = tabs.map { |id, title, url| "#{id}\t#{title}\t#{url}" }.join("\n")

# Preview command for fzf
preview_cmd = '
  echo "Page ID: {1}"
  echo "Title: {2}"
  echo "URL: {3}"
  echo "---"
  bt html {1} | readable --base {3} | html2md
'

# Run fzf to select tabs
fzf_cmd = ['fzf', '--multi', '--delimiter=\t', '--with-nth=2,3', '--preview', preview_cmd]
fzf_output, _, _ = Open3.capture3(*fzf_cmd, stdin_data: fzf_input)

# Process selected tabs
fzf_output.each_line do |line|
  id, title, url = line.strip.split("\t")
  puts "#### #{title} ####\n\n"
  system("bt html #{id} | readable --base \"#{url}\" | html2md")
  puts "\n"
end